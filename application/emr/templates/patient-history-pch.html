<form class="preventiveCareHistory" data-form-target="EMR" novalidate>
  <div class="row mt-2">
    <h3 class="default-label col-12">Preventive Care History</h3>
  </div>

  <div style="overflow-x: auto">
    <table
      class="table table-borderless table-responsive"
      id="preventive-care-history-table"
    >
      <thead>
        <tr align="middle">
          <th scope="col" width="10%">Yes</th>
          <th scope="col" width="10%">No</th>
          <th scope="col" width="30%">Exaamination</th>
          <th scope="col" width="10%">Abnormal</th>
          <th scope="col" width="10%">Normal</th>
          <th scope="col" width="30%">Date</th>
        </tr>
      </thead>
      <tbody align="middle">
        <tr>
          <td>
            <input
              class="form-check-input"
              type="radio"
              id="papsmearYes"
              name="papSmear"
              value="yes"
              aria-label="papsmearYes"
            />
          </td>

          <td>
            <input
              class="form-check-input"
              type="radio"
              id="papsmearNo"
              name="papSmear"
              value="no"
              aria-label="papsmearNo"
              checked
            />
          </td>
          <td>
            <label> Last Pap Smear </label>
          </td>

          <td>
            <input
              class="form-check-input"
              type="radio"
              id="papSmearAbnormal"
              name="papSmearNormalAbnormal"
              value="abnormal"
              aria-label="papsmearAbnormal"
              disabled
            />
          </td>
          <td>
            <input
              class="form-check-input"
              type="radio"
              id="papSmearNormal"
              name="papSmearNormalAbnormal"
              value="normal"
              aria-label="papsmearNormal"
              checked
            />
          </td>
          <td>
            <input
              type="text"
              name="papSmearDate"
              class="form-control datepicker"
              disabled
            />
          </td>
        </tr>

        <tr>
          <td>
            <input
              class="form-check-input"
              type="radio"
              id="mammogramYes"
              name="mammogram"
              value="yes"
              aria-label="mammogramYes"
            />
          </td>

          <td>
            <input
              class="form-check-input"
              type="radio"
              id="mammogramNo"
              name="mammogram"
              value="no"
              aria-label="mammogramNo"
              checked
            />
          </td>
          <td>
            <label> Last Mammogram </label>
          </td>

          <td>
            <input
              class="form-check-input"
              type="radio"
              id="mammogramAbnormal"
              name="mammogramNormalAbnormal"
              value="abnormal"
              aria-label="mammogramAbnormal"
              disabled
            />
          </td>
          <td>
            <input
              class="form-check-input"
              type="radio"
              id="mammogramNormal"
              name="mammogramNormalAbnormal"
              value="normal"
              aria-label="mammogramNormal"
              checked
            />
          </td>
          <td>
            <input
              type="text"
              name="mammogramDate"
              class="form-control datepicker"
              disabled
            />
          </td>
        </tr>

        <tr>
          <td>
            <input
              class="form-check-input"
              type="radio"
              id="colonoscopyYes"
              name="colonoscopy"
              value="yes"
              aria-label="colonoscopyYes"
            />
          </td>

          <td>
            <input
              class="form-check-input"
              type="radio"
              id="colonoscopyNo"
              name="colonoscopy"
              value="no"
              aria-label="colonoscopyNo"
              checked
            />
          </td>
          <td>
            <label> Last Colonoscopy </label>
          </td>

          <td>
            <input
              class="form-check-input"
              type="radio"
              id="colonoscopyAbnormal"
              name="colonoscopyNormalAbnormal"
              value="abnormal"
              aria-label="colonoscopyAbnormal"
              disabled
            />
          </td>
          <td>
            <input
              class="form-check-input"
              type="radio"
              id="colonoscopyNormal"
              name="colonoscopyNormalAbnormal"
              value="normal"
              aria-label="colonoscopyNormal"
              checked
            />
          </td>
          <td>
            <input
              type="text"
              name="colonoscopyDate"
              class="form-control datepicker"
              disabled
            />
          </td>
        </tr>

        <tr>
          <td>
            <input
              class="form-check-input"
              type="radio"
              id="dexaYes"
              name="dexa"
              value="yes"
              aria-label="dexaYes"
            />
          </td>

          <td>
            <input
              class="form-check-input"
              type="radio"
              id="dexaNo"
              name="dexa"
              value="no"
              aria-label="dexaNo"
              checked
            />
          </td>
          <td>
            <label>Last DEXA (Bone Scan) </label>
          </td>

          <td>
            <input
              class="form-check-input"
              type="radio"
              id="dexaAbnormal"
              name="dexaNormalAbnormal"
              value="abnormal"
              aria-label="dexaAbnormal"
              disabled
            />
          </td>
          <td>
            <input
              class="form-check-input"
              type="radio"
              id="dexaaNormal"
              name="dexaNormalAbnormal"
              value="normal"
              aria-label="dexaNormal"
              checked
            />
          </td>
          <td>
            <input
              type="text"
              class="form-control datepicker"
              name="dexaDate"
              disabled
              required
            />
          </td>
        </tr>

        <tr>
          <td>
            <input
              class="form-check-input"
              type="radio"
              id="colesterolTestYes"
              name="colesterolTest"
              value="yes"
              aria-label="colesterolTestYes"
            />
          </td>

          <td>
            <input
              class="form-check-input"
              type="radio"
              id="colesterolTestNo"
              name="colesterolTest"
              value="no"
              aria-label="colesterolTestNo"
              checked
            />
          </td>
          <td>
            <label> Last Colesterol Test </label>
          </td>

          <td>
            <input
              class="form-check-input"
              type="radio"
              id="colesterolTestAbnormal"
              name="colesterolTestNormalAbnormal"
              value="abnormal"
              aria-label="colesterolTestAbnormal"
              disabled
            />
          </td>
          <td>
            <input
              class="form-check-input"
              type="radio"
              id="colesterolTestNormal"
              name="colesterolTestNormalAbnormal"
              value="normal"
              aria-label="colesterolTestNormal"
              checked
            />
          </td>
          <td>
            <input
              type="text"
              name="colesterolTestDate"
              class="form-control datepicker"
              disabled
            />
          </td>
        </tr>
      </tbody>
    </table>

    <div class="mt-3">
      <label for="notes">Notes</label>
      <textarea
        class="form-control"
        id="notes"
        name="additionalNotes"
        rows="3"
      ></textarea>
    </div>
  </div>

  <div class="d-flex justify-content-between mt-3 w-100">
    <input
      type="submit"
      class="btn btn-custom-tertiary emr-prev-btn px-5"
      value="Previous"
      data-next-page="patient-history-cmh"
    />

    <input
      type="submit"
      class="btn btn-success btn-custom-primary px-5 emr-next-btn"
      value="Next"
      data-next-page="patient-history-sh"
    />
  </div>
</form>

<script>
  $(function () {
    loadDatepickers({
      autoclose: true,
      changeMonth: true,
      changeYear: true,
      format: "MM yyyy",
      endDate: "+0d",
      minViewMode: "months",
    });

    let existingData = getDataFromLocalStorage(
      "preventiveCareHistory",
      "patientHistory"
    );

    if (Object.keys(existingData).length) {
      existingData.forEach(function (item, idx) {
        for (const [key, value] of Object.entries(item)) {
          if (key.includes("Date")) {
            $(`input[name=${key}]`).prop("disabled", false);
            $(`input[name=${key}]`).val(value);
          }

          if (key === "Notes") {
            $(`textarea[name=${key}]`).val(value);
          }

          let yesNoBtns = $(`input[name=${key}]`);
          $(yesNoBtns).each(function () {
            if ($(this).prop("value") === "yes") {
              $(this).prop("checked", true);
            }
          });
          let normalAbnormalBtns = $(`input[name=${key}NormalAbnormal]`);
          $(normalAbnormalBtns).each(function () {
            $(this).prop("disabled", false);
            if ($(this).prop("value") === value) {
              $(this).prop("checked", true);
            }
          });
        }
      });
    }

    $(".datepicker").on("keydown", function (e) {
      e.preventDefault();
    });

    $(
      "input[type=radio]:not(input[value=normal]):not(input[value=abnormal])"
    ).on("change", function () {
      let value = $(this).val();
      let siblingRadioNo = $(this)
        .parent()
        .siblings()
        .find("input[value=normal]");
      let siblingRadioYes = $(this)
        .parent()
        .siblings()
        .find("input[value=abnormal]");
      let siblingDatepicker = $(this).parent().siblings().find(".datepicker");

      setDatepickerValueToday(siblingDatepicker, (format = "MONTH"));

      if (value === "yes") {
        siblingDatepicker.attr("disabled", false);
        siblingDatepicker.prop("required", true);
        siblingRadioNo.attr("disabled", false);
        siblingRadioYes.attr("disabled", false);
        console.log(siblingDatepicker);
        return;
      }
      siblingDatepicker.attr("disabled", true);
      siblingDatepicker.prop("required", false);
      siblingRadioNo.attr("disabled", true);
      siblingRadioYes.attr("disabled", true);
      siblingDatepicker.val(null);
    });

    $(".preventiveCareHistory").on("submit", function (evt) {
      evt.preventDefault();
      let preventiveCareHistory = [];

      if ($(this).valid()) {
        // GET VALUES FROM TR WITH 'YES' VALUE
        $(".preventiveCareHistory input[value=yes]:checked").each(function () {
          let name = $(this).attr("name");

          let testResult = $(this)
            .parent()
            .siblings()
            .find("input[type=radio]:checked")
            .val();

          let date = $(this).parent().siblings().find(".datepicker").val();

          let tempObject = {};

          tempObject[name] = testResult;
          tempObject[`${name}Date`] = date;
          preventiveCareHistory.push(tempObject);
        });

        // APPEND ADDITIONAL NOTES
        let notes = $("textarea[name=additionalNotes]").val();

        preventiveCareHistory.push({ notes });
        console.log(preventiveCareHistory);

        saveDataToLocalstorage(
          preventiveCareHistory,
          "preventiveCareHistory",
          "patientHistory"
        );
      }
    });
  });
</script>
