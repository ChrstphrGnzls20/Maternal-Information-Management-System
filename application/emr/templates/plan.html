<form id="plan-form" data-form-target="EMR">
  <!-- <div  class = "row">
    <div class = "form-group">
    <label class = "default-label col-md-4">Prescription</label>
    <button type="button" class="btn btn-success col-md-1 offset-md-6 align-self-end">Add</button>
    </div>
    </div> -->
  <div
    class="d-flex flex-row justify-content-between align-items-center bg-white m-1"
  >
    <h3 class="mb-0">Prescription</h3>
    <!-- <button
      type="button"
      class="btn btn-outline-dark float-end add-emp-btn"
      data-bs-toggle="modal"
      data-bs-target="#prescriptionModal"
    >
      ADD NEW PRESCRIPTION
    </button> -->
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-borderless" id="prescription-table">
      <thead align="middle" style="background-color: rgba(0, 0, 0, 0.05)">
        <tr>
          <th scope="col" width="10%"></th>
          <th scope="col" width="10%">Medicine</th>
          <th scope="col" width="10%">Type</th>
          <th scope="col" width="10%">Dosage</th>
          <th scope="col" width="5%">Measurement</th>
          <th scope="col" width="15%">Frequency</th>
          <th scope="col" width="20%">Instructions</th>
        </tr>
      </thead>

      <tbody align="middle">
        <tr id="tr-dummy">
          <td>
            <button
              class="btn btn-success btn-add"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#prescriptionModal"
            >
              <span>
                <i class="fa-solid fa-plus"></i>
              </span>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3 class="mt-3">Care Plan</h3>

  <div class="row row-cols-1 row-cols-md-2">
    <div class="col form-group d-flex flex-column">
      <label for="follow-up" class="form-label">Follow-up Date</label>
      <input
        type="text"
        class="form-control datepicker"
        id="follow-up-datepicker"
      />
    </div>

    <div class="form-group">
      <label for="patient-status-select" class="form-label"
        >Patient Status</label
      >
      <select class="form-select" id="patient-status-select">
        <option selected value="regular monitoring">Regular Monitoring</option>
        <option value="follow-up">For Follow-up</option>
        <option value="high risk">High Risk</option>
      </select>
    </div>
  </div>

  <div class="row mt-2">
    <div class="form-group col-12">
      <textarea
        class="form-control"
        id="carePlanNotes"
        name="carePlanNotes"
        rows="5"
      ></textarea>
    </div>
  </div>

  <div class="row">
    <div class="d-flex justify-content-center mt-3">
      <button type="button" class="btn btn-primary ms-2">
        View care plan templates
      </button>
      <button type="button" class="btn btn-secondary ms-2">
        Add to templates
      </button>
    </div>
  </div>

  <div class="d-flex justify-content-between mt-3 w-100">
    <input
      type="submit"
      class="btn btn-custom-tertiary emr-prev-btn px-5"
      value="Previous"
      data-next-page="laboratory"
    />

    <input
      type="submit"
      class="btn btn-success btn-custom-primary px-5 emr-next-btn"
      value="Next"
      data-next-page="summary"
    />
  </div>
</form>

<div
  class="modal fade"
  id="prescriptionModal"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  tabindex="-1"
  aria-labelledby="prescriptionModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <form class="addMedicineModal">
      <!--Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="form-group col-12">
              <label for="medicineName" class="form-label">Medicine Name</label>
              <input
                type="text"
                class="form-control"
                id="medicineName"
                name="medicineName"
                required
              />
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group">
              <label for="medicineType" class="form-label">Medicine Type</label>
              <select class="form-select" id="medicineType" name="medicineType">
                <option value="tablet">Tablet</option>
                <option value="capsule">Capsule</option>
                <option value="syrup">Syrup</option>
                <option value="powder">Powder</option>
                <option value="injectable">Injectable</option>
              </select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group col-md-7">
              <label for="medicineDosage" class="form-label">Dosage</label>
              <input
                type="text"
                class="form-control"
                id="medicineDosage"
                name="medicineDosage"
                required
              />
            </div>
            <div class="form-group col-md-5">
              <label for="medicineMeasurement" class="form-label"></label>
              <select
                class="form-select"
                id="medicineMeasurement"
                name="medicineMeasurement"
              >
                <option value="mg">mg</option>
                <option value="ml">ml</option>
                <option value="mcg">mcg</option>
                <option value="tab">tab</option>
                <option value="tsp">teaspoon</option>
                <option value="tbsp">tablespoon</option>
              </select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group col-12">
              <label for="medicineFrequency" class="form-label"
                >Medicine Frequency</label
              >
              <input
                type="text"
                class="form-control"
                id="medicineFrequency"
                name="medicineFrequency"
                required
              />
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group col-12">
              <label
                for="medicalInstructionArea"
                class="form-label"
                id="medicineInstructionlabel"
                >Instructions</label
              >
              <textarea
                class="form-control"
                id="medicineInstructions"
                name="medicineInstructions"
                rows="5"
                required
              ></textarea>
            </div>
          </div>

          <!-- <script>
                let intExamVal = { }
                $(".prescriptionModaal :input").change(function(){
                let intExamName = $(this).attr("name");
                intExamVal[intExamName] = $(this).val();
                console.log(intExamVal);
                });
                </script> -->
        </div>
        <div class="modal-footer">
          <button
            type="button"
            id="cancelBtn"
            class="btn btn-danger"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <input
            type="submit"
            class="btn btn-success ms-2"
            value="Confirm"
            id="surgery-modal-form-submit"
          />
        </div>
      </div>
    </form>
  </div>
</div>

<!-- LOADASH -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
  integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>

<script>
  $(function () {
    loadDatepickers({
      autoclose: true,
      changeMonth: true,
      changeYear: true,
      format: "MM dd, yyyy",
      startDate: "+1d",
    });

    let trIndex = 1;
    let mode = "";
    let activeTrIndex = 0;
    let previousData = {};
    let prescription = [];
    let carePlan = [];

    function generateFormGroup(data) {
      return `
      <input type='text' name='medicineName' value="${data.medicineName}" />
      <input type='text' name='medicineType' value="${data.medicineType}" />
      <input type='text' name='medicineDosage' value="${data.medicineDosage}" />
      <input type='text' name='medicineMeasure' value="${data.medicineMeasure}" />
      <input type='text' name='medicineFrequency' value="${data.medicineFrequency}" />
      <input type='text' name='medicineInstructions' value="${data.medicineInstructions}" />
      `;

      // let form = $("form[data-form-target=EMR]");
      // form.append(toInsert);
    }

    function generateTableTDs(data) {
      return `
      <td>
        <button type="button" class="btn btn-warning btn-edit" data-bs-toggle="modal"
              data-bs-target="#prescriptionModal">
          <span>
            <i class="fa-solid fa-pen"></i>
          </span>      
        </button>
        <button type="button" class="btn btn-danger btn-delete">
          <span>
            <i class="fa-solid fa-x"></i>
          </span>      
        </button>
      </td>
      <td>
        ${data.medicineName}
      </td>
      <td>
        ${data.medicineType}
      </td>
      <td>
        ${data.medicineDosage}
      </td>
      <td>
        ${data.medicineMeasurement}
      </td>
      <td>
        ${data.medicineFrequency}
      </td>
      <td>
        ${data.medicineInstructions}
      </td>
      `;
    }

    // when add button (+) is clicked
    $("#prescription-table").on("click", ".btn-add", function () {
      mode = "ADD";

      clearModalTextFields((modalClass = ".modal"));
    });

    // when edit button is clicked
    $("#prescription-table").on("click", ".btn-edit", function () {
      mode = "EDIT";
      let trParent = $(this).parent().parent();
      activeTrIndex = trParent.attr("data-row-index");
      clearModalTextFields((modalClass = ".modal"));

      // let inputs = $(`div[data-row-index=${activeTrIndex}]`).find("input");
      // // console.log(trParent.find("input[type=text]"));
      // inputs.each(function () {
      //   let name = $(this).attr("name");
      //   let value = $(this).val();
      //   $(`.modal input[name=${name}]`).val(value);
      // });

      let siblings = $(this).parent().siblings();
      let medicineName = $(siblings[0]).text().trim();
      let medicineType = $(siblings[1]).text().trim();
      let medicineDosage = $(siblings[2]).text().trim();
      let medicineMeasurement = $(siblings[3]).text().trim();
      let medicineFrequency = $(siblings[4]).text().trim();
      let medicineInstructions = $(siblings[5]).text().trim();

      // POPULATE MODAL FIELDS
      $("#prescriptionModal input[name=medicineName]").val(medicineName);
      $("#prescriptionModal input[name=medicineType]").val(medicineType);
      $("#prescriptionModal input[name=medicineDosage]").val(medicineDosage);
      $("#prescriptionModal input[name=medicineMeasurement]").val(
        medicineMeasurement
      );
      $("#prescriptionModal input[name=medicineFrequency]").val(
        medicineFrequency
      );
      $("#prescriptionModal textarea[name=medicineInstructions]").val(
        medicineInstructions
      );

      Object.assign(
        previousData,
        { medicineName: medicineName },
        { medicineType: medicineType },
        { medicineDosage: medicineDosage },
        { medicineMeasurement: medicineMeasurement },
        { medicineFrequency: medicineFrequency },
        { medicineInstructions: medicineInstructions }
      );
    });

    $("#prescription-table").on("click", ".btn-delete", function () {
      let trParent = $(this).parent().parent();

      trParent.remove();

      // REMOVE DELETED VALUE
      let siblings = $(this).parent().siblings();
      let medicineName = $(siblings[0]).text().trim();
      let medicineType = $(siblings[1]).text().trim();
      let medicineDosage = $(siblings[2]).text().trim();
      let medicineMeasurement = $(siblings[3]).text().trim();
      let medicineFrequency = $(siblings[4]).text().trim();
      let medicineInstructions = $(siblings[5]).text().trim();

      Object.assign(
        previousData,
        { medicineName: medicineName },
        { medicineType: medicineType },
        { medicineDosage: medicineDosage },
        { medicineMeasurement: medicineMeasurement },
        { medicineFrequency: medicineFrequency },
        { medicineInstructions: medicineInstructions }
      );

      prescription = prescription.filter((item) => {
        return !_.isEqual(item, previousData);
      });
    });

    // when submitting modal form
    $("#prescriptionModal form").on("submit", function (evt) {
      // pass
      evt.preventDefault();

      let submittedValues = $(this).serializeArray();

      let data = cleanData(submittedValues);

      if (mode === "ADD") {
        generateFormGroup(data);
        let TDs = generateTableTDs(data);

        // append generated TR to table
        let toAppend = `
        <tr data-row-index=${trIndex}>
          ${TDs}
        </tr>
        `;
        $(toAppend).insertBefore("#tr-dummy");

        // add fields to hidden div that holds form data
        // let newFormGroup = generateFormGroup(data);
        // toAppend = `
        // <div data-row-index=${trIndex} style="display: none;">
        //   ${newFormGroup}
        // </div>
        // `;

        // let form = $("form[data-form-target=EMR]");
        // form.append(toAppend);

        // APPEND VALUES TO EXISTING OBJECT
        prescription.push(data);

        trIndex++;
      } else {
        // edit functionality
        let trParent = $(`table tr[data-row-index=${activeTrIndex}]`);

        // update table row values
        trParent.empty();
        let TDs = generateTableTDs(data);
        trParent.append(TDs);

        // update hidden form values
        // let currentFormDiv = $(`div[data-row-index=${activeTrIndex}]`);

        // currentFormDiv.empty();
        // let newFormGroup = generateFormGroup(data);
        // currentFormDiv.append(newFormGroup);

        // APPEND UPDATED VALUES TO EXISTING OBJECT
        prescription = prescription.filter((item) => {
          return !_.isEqual(item, previousData);
        });
        prescription.push(data);
      }

      $("#prescriptionModal").modal("hide");
    });

    $("#plan-form").on("submit", function () {
      console.log(prescription);
    });
  });
</script>

<!-- <script>
  $(function () {
    loadDatepickers({
      autoclose: true,
      changeMonth: true,
      changeYear: true,
      format: "mm dd,yyyy",
      startDate: "+0d",
    });

    let mode = "";
    let trIndex = 1;

    $("table").on("click", ".btn-add", function () {
      mode = "ADD";

      $(".modal input[type=text]").each(function () {
        $(this).val("");
      });
    });

    function addInputs(data) {
      let toBeAdded = `
      <tr data-row-index=${trIndex}>
        <td>
          <button type="button" class="btn btn-warning btn-edit" data-bs-toggle="modal"
                data-bs-target="#prescriptionModal">
            <span>
              <i class="fa-solid fa-pen"></i>
            </span>      
          </button>
          <button type="button" class="btn btn-danger btn-delete">
            <span>
              <i class="fa-solid fa-x"></i>
            </span>      
          </button>
        </td>
        <td>
          <input
          type="text"
          class="form-control"
          id="medicineName"
          name="medicineName"
          value=${data.medicineName}
          readonly
          />
        </td>
        <td>
          <input
          type="text"
          class="form-control"
          id="medicineType"
          name="medicineType"
          value=${data.medicineType}
          readonly
          />
        </td>
        <td>
          <input
          type="text"
          class="form-control"
          id="medicineDosage"
          name="medicineDosage"
          value=${data.medicineDosage}
          readonly
          />
        </td>
        <td>
          <input
          type="text"
          class="form-control"
          id="medicineFrequency"
          name="medicineFrequency"
          value=${data.medicineFrequency}
          readonly
          />
        </td>
        <td>
          <input
          type="text"
          class="form-control"
          id="medicineInstructions"
          name="medicineInstructions"
          value=${data.medicineInstructions}
          readonly
          />
        </td>
      </tr>`;

      let tbody = $("table tbody");

      tbody.prepend(toBeAdded);
    }

    $("table").on("click", ".btn-edit", function () {
      mode = "EDIT";
      let trParent = $(this).parent().parent();
      activeTrIndex = trParent.attr("data-row-index");

      let inputs = trParent.find("input[type=text]");
      // console.log(trParent.find("input[type=text]"));
      inputs.each(function () {
        let name = $(this).attr("name");
        let value = $(this).val();
        $(`.modal input[name=${name}]`).val(value);
      });
    });

    $("table").on("click", ".btn-delete", function () {
      let trParent = $(this).parent().parent();

      trParent.remove();
    });

    $(".modal form").on("submit", function (evt) {
      evt.preventDefault();

      // if ($(this).valid()) {
      let submittedValues = $(this).serializeArray();

      let data = cleanData(submittedValues);

      if (mode === "ADD") {
        addInputs(data);
        trIndex++;
      } else {
        // edit functionality
        let trParent = $(`table tr[data-row-index=${activeTrIndex}]`);

        let inputs = trParent.find("input[type=text]");

        inputs.each(function (idx) {
          let name = $(this).attr("name");
          $(this).val(data[name]);
        });
      }

      $(".modal").modal("hide");
    });
  });
</script> -->
