<form id="plan-form" data-form-target="EMR">
  <div
    class="d-flex flex-row justify-content-between align-items-center bg-white m-1"
  >
    <h3 class="mb-0">Prescription</h3>
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-borderless" id="prescription-table">
      <thead align="middle" style="background-color: rgba(0, 0, 0, 0.05)">
        <tr>
          <th scope="col" width="10%"></th>
          <th scope="col" width="10%">Medicine</th>
          <th scope="col" width="10%">Type</th>
          <th scope="col" width="10%">Dosage</th>
          <th scope="col" width="5%">Measurement</th>
          <th scope="col" width="15%">Frequency</th>
          <th scope="col" width="15%">Period</th>
          <th scope="col" width="20%">Instructions</th>
        </tr>
      </thead>

      <tbody align="middle"></tbody>
    </table>
  </div>

  <h3 class="mt-3">Care Plan</h3>

  <div class="row row-cols-1 row-cols-md-2">
    <div class="form-group">
      <label for="patient-status-select" class="form-label required"
        >Patient Status</label
      >
      <select class="form-select" id="patient-status-select">
        <option selected value="regular checkup">Regular Checkup</option>
        <option value="follow-up">For Follow-up</option>
        <option value="high risk">High Risk</option>
      </select>
    </div>
    <div class="col form-group d-flex flex-column">
      <div>
        <label for="follow-up-datepicker" class="form-label"
          >Follow-up Date and Time</label
        >
        <div class="d-flex flex-row">
          <input
            type="text"
            class="me-2 form-control datepicker"
            id="follow-up-datepicker"
            placeholder="Date"
          />
          <input
            type="text"
            class="form-control timepicker"
            id="follow-up-time"
            placeholder="Time"
            disabled
          />
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-2">
    <div class="form-group col-12">
      <label for="carePlanNotes" class="form-label">Patient Education</label>
      <textarea
        class="form-control"
        id="carePlanNotes"
        name="carePlanNotes"
        rows="5"
      ></textarea>
    </div>
  </div>

  <div class="row">
    <div class="d-flex justify-content-center mt-3">
      <button
        type="button"
        class="btn btn-primary ms-2"
        data-bs-toggle="modal"
        data-bs-target="#viewCarePlanModal"
        id="view-care-plan-btn"
      >
        View care plan templates
      </button>
      <button
        type="button"
        class="btn btn-secondary ms-2"
        id="add-to-templates"
        data-bs-toggle="modal"
        data-bs-target="#addCarePlanModal"
      >
        Add to templates
      </button>
    </div>
  </div>

  <div class="d-flex justify-content-between mt-3 w-100">
    <input
      type="submit"
      class="btn btn-custom-tertiary emr-prev-btn px-5"
      value="Previous"
      data-next-page="laboratory"
    />

    <input
      type="submit"
      class="btn btn-success btn-custom-primary px-5 emr-next-btn"
      value="Next"
      data-next-page="summary"
    />
  </div>
</form>

<!-- PRESCRIPTION MODAL -->
<div
  class="modal fade"
  id="prescriptionModal"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  tabindex="-1"
  aria-labelledby="prescriptionModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <form class="addMedicineModal">
      <!--Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="mb-0 modal-header-text"></h3>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="form-group col-12">
              <label for="medicineName" class="form-label">Medicine Name</label>
              <input
                type="text"
                class="form-control"
                id="medicineName"
                name="medicineName"
                required
              />
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group">
              <label for="medicineType" class="form-label">Medicine Type</label>
              <select class="form-select" id="medicineType" name="medicineType">
                <option value="tablet">Tablet</option>
                <option value="capsule">Capsule</option>
                <option value="syrup">Syrup</option>
                <option value="powder">Powder</option>
                <option value="injectable">Injectable</option>
              </select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group col-md-7">
              <label for="medicineDosage" class="form-label">Dosage</label>
              <input
                type="text"
                class="form-control"
                id="medicineDosage"
                name="medicineDosage"
                required
              />
            </div>
            <div class="form-group col-md-5">
              <label for="medicineMeasurement" class="form-label"></label>
              <select
                class="form-select"
                id="medicineMeasurement"
                name="medicineMeasurement"
              >
                <option value="mg">mg</option>
                <option value="ml">ml</option>
                <option value="mcg">mcg</option>
                <option value="tab">tab</option>
                <option value="tsp">teaspoon</option>
                <option value="tbsp">tablespoon</option>
              </select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group col-12">
              <label for="medicineFrequency" class="form-label"
                >Medicine Frequency <b>(per day)</b></label
              >
              <input
                type="number"
                class="form-control"
                id="medicineFrequency"
                name="medicineFrequency"
                min="1"
                required
              />
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group col-12">
              <label for="medicinePeriod" class="form-label"
                >Take for how many days?
              </label>
              <input
                type="number"
                class="form-control"
                id="medicinePeriod"
                name="medicinePeriod"
                min="1"
                required
              />
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group col-12">
              <label
                for="medicalInstructionArea"
                class="form-label"
                id="medicineInstructionlabel"
                >Instructions</label
              >
              <textarea
                class="form-control"
                id="medicineInstructions"
                name="medicineInstructions"
                rows="5"
                required
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            id="cancelBtn"
            class="btn btn-danger"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <input
            type="submit"
            class="btn btn-success ms-2"
            value="Confirm"
            id="surgery-modal-form-submit"
          />
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ADD CARE PLAN MODAL -->
<div
  class="modal fade"
  id="addCarePlanModal"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  tabindex="-1"
  aria-labelledby="addCarePlanModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <form id="add-care-plan-form">
      <!--Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="mb-0 modal-header-text">Add new care plan</h3>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="form-group">
              <label for="add-care-plan-title" class="form-label required"
                >Care Plan For</label
              >
              <input
                type="text"
                class="form-control"
                id="add-care-plan-title"
                name="carePlanTitle"
                required
              />
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group col-12">
              <label for="add-care-plan-text" class="form-label required"
                >Care Plan</label
              >
              <textarea
                class="form-control"
                id="add-care-plan-text"
                name="carePlanText"
                rows="5"
                required
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            id="cancelBtn"
            class="btn btn-danger"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <input
            type="submit"
            class="btn btn-success ms-2"
            value="Add to templates"
          />
        </div>
      </div>
    </form>
  </div>
</div>

<!-- VIEW CARE PLAN MODAL -->
<div
  class="modal fade"
  id="viewCarePlanModal"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
  tabindex="-1"
  aria-labelledby="viewCarePlanModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <form id="add-care-plan-form">
      <!--Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="mb-0 modal-header-text">View care plan templates</h3>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="form-group">
              <label for="view-care-plan-title" class="form-label"
                >Care Plan For</label
              >
              <select
                class="form-select"
                name="viewCarePlanTitle"
                id="view-care-plan-select"
              ></select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="form-group col-12">
              <label for="add-care-plan-text" class="form-label"
                >Care Plan</label
              >
              <textarea
                class="form-control"
                id="view-care-plan-text"
                name="carePlanText"
                rows="5"
                readonly
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            id="cancelBtn"
            class="btn btn-danger"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button
            type="button"
            id="useBtn"
            class="btn btn-success"
            data-bs-dismiss="modal"
          >
            Use template
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- LOADASH -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
  integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>

<!-- FOR PRESCRIPTION -->
<script defer>
  $(function () {
    loadDatepickers({
      autoclose: true,
      changeMonth: true,
      changeYear: true,
      format: "MM d, yyyy",
      startDate: "+1d",
    });

    $(".timepicker").timepicker({
      step: 30,
      minTime: "8am",
      maxTime: "5pm",
      defaultTime: "08",
      forceRoundTime: true,
      timeFormat: "h:i A",
      scrollbar: false,
    });

    let trIndex = 1;
    let mode = "";
    let activeTrIndex = 0;
    let previousData = {};
    let prescription = [];
    let carePlan = [];

    function generateFormGroup(data) {
      return `
      <input type='text' name='medicineName' value="${data.medicineName}" />
      <input type='text' name='medicineType' value="${data.medicineType}" />
      <input type='text' name='medicineDosage' value="${data.medicineDosage}" />
      <input type='text' name='medicineMeasure' value="${data.medicineMeasure}" />
      <input type='text' name='medicineFrequency' value="${data.medicineFrequency}" />
      <input type='text' name='medicineInstructions' value="${data.medicineInstructions}" />
      `;
    }

    function generateTableTDs(data) {
      return `
      <td>
        <button type="button" class="btn btn-warning btn-edit" data-bs-toggle="modal"
              data-bs-target="#prescriptionModal">
          <span>
            <i class="fa-solid fa-pen"></i>
          </span>
        </button>
        <button type="button" class="btn btn-danger btn-delete">
          <span>
            <i class="fa-solid fa-x"></i>
          </span>
        </button>
      </td>
      <td>
        ${data.medicineName}
      </td>
      <td>
        ${data.medicineType}
      </td>
      <td>
        ${data.medicineDosage}
      </td>
      <td>
        ${data.medicineMeasurement}
      </td>
      <td>
        ${data.medicineFrequency} x a day
      </td>
      <td>
        for ${data.medicinePeriod} days
      </td>
      <td>
        ${data.medicineInstructions}
      </td>
      `;
    }

    function updateTable(dataArray) {
      let tableBody = $("#prescription-table tbody");
      let trWithAddBtn = `<tr id="tr-dummy">
          <td>
            <button
              class="btn btn-success btn-add"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#prescriptionModal"
            >
              <span>
                <i class="fa-solid fa-plus"></i>
              </span>
            </button>
          </td>
        </tr>`;

      tableBody.empty();
      tableBody.append(trWithAddBtn);

      if (!dataArray.length) return;

      dataArray.forEach(function (item) {
        let TDs = generateTableTDs(item);

        // APPEND GENERATED TR TO TABLE
        let toAppend = `
        <tr>
          ${TDs}
        </tr>
        `;
        $(toAppend).insertBefore("#tr-dummy");
      });
    }

    // FUNCTIONALITY TO LOAD EXISTING DATA FROM LOCALSTORAGE
    let existingData = getDataFromLocalStorage("plan");

    console.log(existingData);
    carePlan = existingData["carePlan"];
    prescription = existingData["prescription"];

    updateTable(prescription);

    if (prescription.length) {
      console.log(prescription);

      updateTable(prescription);
    }

    if (Object.keys(carePlan).length) {
      if (carePlan["followUpDate"]) {
        let followUpDate = moment(carePlan["followUpDate"]).format("LL");
        let followUpTime = moment(carePlan["followUpDate"]).format("hh:mm a");

        $("#follow-up-datepicker").val(followUpDate);
        $("#follow-up-time").val(followUpTime);
        $("#follow-up-time").prop("disabled", false);
      }

      $("#carePlanNotes").val(carePlan["carePlanNotes"]);
      $(
        `#patient-status-select option[value='${carePlan["patientStatus"]}'`
      ).attr("selected", "selected");
    }

    // PRESCRIPTION FUNCTIONALITIES
    $("#follow-up-datepicker").on("keydown", function (e) {
      if (e.keyCode == 8 || e.keyCode == 46) {
        $(this).val("");
        $(this).trigger("change");
      }
      e.preventDefault();
    });

    $("#follow-up-time").on("keydown", function (e) {
      e.preventDefault();
    });

    $("#follow-up-datepicker").on("change", function () {
      console.log("CHANGED");
      if ($(this).val() != "") {
        $("#follow-up-time").timepicker("setTime", "8");
        $("#follow-up-time").prop("disabled", false);
        return;
      }
      $("#follow-up-time").val("");
      $("#follow-up-time").prop("disabled", true);
    });

    // when add button (+) is clicked
    $("#prescription-table").on("click", ".btn-add", function () {
      // CHANGE MODAL HEADER TEXT
      $(".modal-header-text").text("Add new medicine");
      mode = "ADD";

      clearModalTextFields((modalClass = ".modal"));
    });

    // when edit button is clicked
    $("#prescription-table").on("click", ".btn-edit", function () {
      // CHANGE MODAL HEADER TEXT
      $(".modal-header-text").text("Edit prescription");

      mode = "EDIT";
      let trParent = $(this).parent().parent();
      activeTrIndex = trParent.attr("data-row-index");
      clearModalTextFields((modalClass = ".modal"));

      let siblings = $(this).parent().siblings();
      let medicineName = $(siblings[0]).text().trim();
      let medicineType = $(siblings[1]).text().trim();
      let medicineDosage = $(siblings[2]).text().trim();
      let medicineMeasurement = $(siblings[3]).text().trim();
      let medicineFrequency = $(siblings[4])
        .text()
        .replace(" x a day", "")
        .trim();
      let medicinePeriod = $(siblings[5])
        .text()
        .replace("for ", "")
        .replace(" days", "")
        .trim();
      let medicineInstructions = $(siblings[6]).text().trim();

      // POPULATE MODAL FIELDS
      $("#prescriptionModal input[name=medicineName]").val(medicineName);
      $("#prescriptionModal input[name=medicineType]").val(medicineType);
      $("#prescriptionModal input[name=medicineDosage]").val(medicineDosage);
      $("#prescriptionModal input[name=medicineMeasurement]").val(
        medicineMeasurement
      );
      $("#prescriptionModal input[name=medicineFrequency]").val(
        medicineFrequency
      );
      $("#prescriptionModal input[name=medicinePeriod]").val(medicinePeriod);
      $("#prescriptionModal textarea[name=medicineInstructions]").val(
        medicineInstructions
      );

      Object.assign(
        previousData,
        { medicineName },
        { medicineType },
        { medicineDosage },
        { medicineMeasurement },
        { medicineFrequency },
        { medicinePeriod },
        { medicineInstructions }
      );

      console.log(previousData);
    });

    $("#prescription-table").on("click", ".btn-delete", function () {
      // REMOVE DELETED VALUE
      let siblings = $(this).parent().siblings();
      let medicineName = $(siblings[0]).text().trim();
      let medicineType = $(siblings[1]).text().trim();
      let medicineDosage = $(siblings[2]).text().trim();
      let medicineMeasurement = $(siblings[3]).text().trim();
      let medicineFrequency = $(siblings[4])
        .text()
        .replace(" x a day", "")
        .trim();
      let medicinePeriod = $(siblings[5])
        .text()
        .replace("for ", "")
        .replace(" days", "")
        .trim();
      let medicineInstructions = $(siblings[6]).text().trim();

      Object.assign(
        previousData,
        { medicineName },
        { medicineType },
        { medicineDosage },
        { medicineMeasurement },
        { medicineFrequency },
        { medicinePeriod },

        { medicineInstructions: medicineInstructions }
      );

      prescription = prescription.filter((item) => {
        return !_.isEqual(item, previousData);
      });

      updateTable(prescription);
    });

    // when submitting modal form
    $("#prescriptionModal form").on("submit", function (evt) {
      // pass
      evt.preventDefault();

      let submittedValues = $(this).serializeArray();

      let data = cleanData(submittedValues);

      if (mode === "ADD") {
        // APPEND VALUES TO EXISTING OBJECT
        prescription.push(data);

        updateTable(prescription);
      } else {
        // EDIT FUNCTIONALITY
        // APPEND UPDATED VALUES TO EXISTING OBJECT
        prescription = prescription.filter((item) => {
          return !_.isEqual(item, previousData);
        });
        prescription.push(data);

        updateTable(prescription);
      }

      $("#prescriptionModal").modal("hide");
    });

    $("#plan-form").on("submit", function () {
      let followUpDay = $("#follow-up-datepicker").val();
      let followUpTime = $("#follow-up-time").val();

      console.log(followUpDay, followUpTime);
      let followUpDate = "";
      if (followUpDay && followUpTime) {
        followUpDate = new Date(`${followUpDay} ${followUpTime}`).toISOString();
      }

      let patientStatus = $("#patient-status-select").val();
      let carePlanNotes = $("#carePlanNotes").val();

      let carePlan = {
        followUpDate,
        patientStatus,
        carePlanNotes,
      };

      let plan = {
        prescription,
        carePlan,
      };
      saveDataToLocalstorage(plan, "plan");
    });
  });
</script>

<!-- FOR CARE PLAN -->
<script>
  $(function () {
    function addCarePlan(data) {
      return $.ajax({
        method: "POST",
        url: `${API_BASE_URL}/emr/care-plan`,
        dataType: "json",
        contentType: "application/json",
        data: JSON.stringify(data),
      });
    }

    function getCarePlans(doctorID, carePlanID = null) {
      let url = carePlanID
        ? `${API_BASE_URL}/emr/care-plan/${doctorID}/${carePlanID}`
        : `${API_BASE_URL}/emr/care-plan/${doctorID}`;

      return $.ajax({
        method: "GET",
        url: url,
        dataType: "json",
        contentType: "application/json",
      });
    }

    let selectedCarePlan = {};

    $("#add-to-templates").on("click", function () {
      $("#add-care-plan-text").val($("#carePlanNotes").val());
    });

    $("#add-care-plan-form").on("submit", function (e) {
      e.preventDefault();
      let cleanedData = cleanData($(this).serializeArray());
      console.log(cleanedData);

      // TODO: add doctor_id,

      addCarePlan(cleanedData)
        .then(function (response) {
          console.log("SUCCESS!");
        })
        .catch(function (xhr) {
          console.log(xhr);
        });

      // CLOSE MODAL
      $("#addCarePlanModal").modal("hide");
    });

    $("#view-care-plan-btn").on("click", function () {
      selectedCarePlan = {};

      // CLEAR TEXTAREA
      $("#view-care-plan-text").val("");

      getCarePlans((doctorID = "123123"))
        .then(function (response) {
          let data = response;

          // CLEAR SELECT
          $("#view-care-plan-select").empty();
          $("<option value=''>Select care plan</option>").appendTo(
            $("#view-care-plan-select")
          );

          data.forEach(function (item) {
            $(
              `<option value='${item["carePlanTitle"]}' data-id=${item["_id"]}>${item["carePlanTitle"]}</option>`
            ).appendTo($("#view-care-plan-select"));
          });

          // DELETE ALL EVENT HANDLER OF SELECT BEFORE ADDING NEW ONE
          $("#view-care-plan-select").off("change");

          $("#view-care-plan-select").on("change", function () {
            console.log("I CHANGED");
            let selectedOptionId = $(this).find(":selected").data("id");

            selectedCarePlan =
              data.find((item) => item["_id"] === selectedOptionId) || {};

            if (!Object.keys(selectedCarePlan).length) {
              $("#view-care-plan-text").val("");
            }
            $("#view-care-plan-text").val(selectedCarePlan["carePlanText"]);
          });
        })
        .catch(function (xhr) {
          console.log(xhr);
        });
    });

    $("#useBtn").on("click", function () {
      if (!Object.keys(selectedCarePlan).length) return;
      let toAppendText = selectedCarePlan["carePlanText"];

      let currentCarePlanNote = $("#carePlanNotes").val();

      $("#carePlanNotes").val(`${currentCarePlanNote}\n${toAppendText}`);

      console.log(currentCarePlanNote);
      console.log(toAppendText);
    });
  });
</script>
